<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Execução de Chaincodes</title>

<style>
:root {
  --primary: #1e7a35;
  --primary-dark: #145427;
  --bg: #f4fbf6;
  --card: #ffffff;
  --muted: #6b8b73;
}

body {
  font-family: Arial, sans-serif;
  background-color: var(--bg);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.container {
  background: var(--card);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0,0,0,.1);
  width: 95%;
  max-width: 600px;
  text-align: center;
}

h2 {
  color: var(--primary-dark);
}

.form-group {
  margin-bottom: 15px;
  display: flex;
  flex-direction: column;
}

label {
  font-weight: bold;
  color: var(--muted);
  text-align: left;
  margin-bottom: 5px;
}

select, textarea, input[type="file"] {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #cfe6d4;
  font-size: 1rem;
}

textarea {
  font-family: monospace;
}

.test-id-wrapper {
  display: flex;
  border: 1px solid #cfe6d4;
  border-radius: 8px;
  overflow: hidden;
}

.test-id-prefix {
  background: #e7f4ea;
  padding: 10px;
  font-family: monospace;
  font-weight: bold;
}

#testNumber {
  border: none;
  padding: 10px;
  font-family: monospace;
  width: 100%;
}

.hidden {
  display: none;
}

button {
  padding: 10px 20px;
  background: var(--primary);
  color: white;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}

button:hover {
  background: var(--primary-dark);
}
</style>
</head>

<body>
<div class="container">
<h2>Execução de Chaincodes</h2>

<!-- OPERAÇÃO -->
<div class="form-group">
<label>Operação</label>
<select id="operation">
  <option value="store-test">Salvar Teste</option>
  <option value="store-image">Salvar Imagem</option>
  <option value="store-model">Salvar Modelo</option>
  <option value="query-test">Consultar Teste</option>
  <option value="query-image">Consultar Imagem</option>
  <option value="update-test">Atualizar Teste</option>
</select>
</div>

<!-- TEST ID NORMAL -->
<div class="form-group" id="testIdGroup">
<label id="testIdLabel">TEST-ID</label>
<div class="test-id-wrapper">
  <span class="test-id-prefix" id="testPrefix">TEST-</span>
  <input id="testNumber" />
</div>
</div>

<!-- MODEL SELECT -->
<div class="form-group hidden" id="modelKeyGroup">
<label>Model Key</label>
<select id="modelKey">
  <option value="acao_recomendada">acao_recomendada</option>
  <option value="qc_status">qc_status</option>
  <option value="result_class">result_class</option>
</select>
</div>

<!-- ARQUIVO -->
<div class="form-group">
<label>Arquivo</label>
<input type="file" id="fileInput" />
</div>

<!-- JSON EDITOR -->
<div class="form-group hidden" id="jsonEditorGroup">
<label>JSON do Teste</label>
<textarea id="jsonEditor" rows="10"></textarea>
</div>

<!-- Box de result do hash da imagem -->
<div class="form-group hidden" id="imageResultGroup">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <label>Hash da Imagem</label>
    <button type="button" id="copyHashBtn">Copiar</button>
  </div>
  <textarea id="imageResult" rows="2" readonly></textarea>
</div>

<button id="executeBtn">Executar</button>
</div>

<script>
const operation = document.getElementById("operation");
const testPrefix = document.getElementById("testPrefix");
const testIdGroup = document.getElementById("testIdGroup");
const modelKeyGroup = document.getElementById("modelKeyGroup");
const testIdLabel = document.getElementById("testIdLabel");

let updateLoaded = false;

copyHashBtn.onclick = () => {
  imageResult.select();
  document.execCommand("copy");
  alert("Hash copiado para a área de transferência");
};

operation.onchange = () => {
  const op = operation.value;

  testIdGroup.classList.remove("hidden");
  modelKeyGroup.classList.add("hidden");

  if (op === "store-image" || op === "query-image") {
    testPrefix.innerText = "";
    testIdLabel.innerText = "IMAGE-ID";
  } 
  else if (op === "store-model") {
    testIdGroup.classList.add("hidden");
    modelKeyGroup.classList.remove("hidden");
  } 
  else {
    testPrefix.innerText = "TEST-";
    testIdLabel.innerText = "TEST-ID";
  }
};

function getTestID() {
  const op = operation.value;
  const value = document.getElementById("testNumber").value.trim();

  if (op === "store-image" || op === "query-image") {
    return value;
  }

  return "TEST-" + value;
}

async function postJSON(url, data, method = "POST") {
  const res = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  if (!res.ok) {
    const err = await res.text();
    throw new Error(err);
  }

  return res.json();
}

/* -------- STORE -------- */

async function handleStoreTest() {
  const file = fileInput.files[0];
  if (!file) return alert("Selecione um arquivo");

  const data = JSON.parse(await file.text());
  await postJSON("/store/test", { data });

  alert("Teste armazenado");
}

async function handleStoreImage() {
  const form = new FormData();
  form.append("image", fileInput.files[0]);
  form.append("imageID", getTestID());

  const res = await fetch("/store/image", {
    method: "POST",
    body: form
  });

  if (!res.ok) throw new Error(await res.text());
  alert("Imagem armazenada");
}

async function handleStoreModel() {
  const form = new FormData();
  form.append("model", fileInput.files[0]);
  form.append("modelKey", document.getElementById("modelKey").value);

  const res = await fetch("/store/model", {
    method: "POST",
    body: form
  });

  if (!res.ok) throw new Error(await res.text());
  alert("Modelo armazenado");
}

//rotas query

async function handleQueryTest() {
  const result = await postJSON("/query/test", {
    testID: getTestID()
  });

  jsonEditor.value = JSON.stringify(result, null, 2);
  jsonEditorGroup.classList.remove("hidden");
}

async function handleQueryImage() {
  const result = await postJSON("/query/image", {
    imageID: getTestID()
  });

  imageResult.value = result.hash || "";
  imageResultGroup.classList.remove("hidden");
}

//rota update

async function handleUpdateTest() {
  const testID = getTestID();

  if (!updateLoaded) {
    const current = await postJSON(
      "/query/test",
      { testID }
    );

    jsonEditor.value = JSON.stringify(current, null, 2);
    jsonEditorGroup.classList.remove("hidden");

    updateLoaded = true;
    alert("Teste carregado. Edite os dados e clique em Executar novamente para salvar.");
    return;
  }

  if (!confirm("Deseja salvar as alterações?")) return;

  const parsed = JSON.parse(jsonEditor.value);

  await postJSON(
    "/update/test",
    { testID, data: parsed },
    "PUT"
  );

  alert("Teste atualizado com sucesso");

  updateLoaded = false;
}

//dispatch de chamadas

executeBtn.onclick = async () => {
  const op = operation.value;

  try {
    if (op === "store-test") return handleStoreTest();
    if (op === "store-image") return handleStoreImage();
    if (op === "store-model") return handleStoreModel();
    if (op === "query-test") return handleQueryTest();
    if (op === "query-image") return handleQueryImage();
    if (op === "update-test") return handleUpdateTest();
  } catch (err) {
    console.error(err);
    alert("Erro:\n" + err.message);
  }
};
</script>
</body>
</html>
