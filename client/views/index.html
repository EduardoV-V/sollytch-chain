<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Execução de Chaincodes</title>
    <style>
      :root {
        --primary: #1e7a35;
        --primary-dark: #145427;
        --bg: #f4fbf6;
        --card: #ffffff;
        --muted: #6b8b73;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .container {
        background: var(--card);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 500px;
        text-align: center;
      }

      .container h2 {
        margin-bottom: 20px;
        color: var(--primary-dark);
      }

      .form-group {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: var(--muted);
        width: 100%;
        text-align: left;
      }

      /* Grupo do TEST-ID com prefixo fixo */
      .test-id-wrapper {
        display: flex;
        align-items: center;
        border: 1px solid #cfe6d4;
        border-radius: 8px;
        width: 100%;
        background: white;
        overflow: hidden;
      }

      .test-id-prefix {
        background: #e7f4ea;
        color: var(--primary-dark);
        font-family: "Courier New", monospace;
        padding: 10px;
        border-right: 1px solid #cfe6d4;
        font-weight: bold;
        user-select: none;
      }

      #testNumber {
        border: none;
        outline: none;
        padding: 10px;
        font-size: 1rem;
        font-family: "Courier New", monospace;
        width: 100%;
      }

      .form-group input[type="file"],
      .form-group .checkbox-wrapper {
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        border: 1px solid #cfe6d4;
        border-radius: 8px;
        font-size: 1rem;
        margin-bottom: 8px;
      }

      .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-start;
        padding: 8px;
      }

      .button-group {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 10px;
      }

      .button-group button {
        padding: 10px 20px;
        border: none;
        background-color: var(--primary);
        color: white;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        min-width: 120px;
      }

      .button-group button:hover {
        background-color: var(--primary-dark);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Execução de Chaincodes</h2>
      <div class="form-group">
        <label for="testNumber">TEST-ID</label>
        <div class="test-id-wrapper">
          <span class="test-id-prefix">TEST-</span>
          <input type="text" id="testNumber" placeholder="" />
        </div>
      </div>
      <div class="form-group">
        <label for="fileInput">Arquivo (CSV, JSON, XLSX)</label>
        <input type="file" id="fileInput" accept=".csv, .json, .xlsx" />
      </div>
      <div class="form-group" style="align-items: flex-start; width:100%;">
        <label class="checkbox-wrapper" for="searchAll">
          <input type="checkbox" id="searchAll" />
          <span>Buscar todos os testes?</span>
        </label>
        <br>

        <label class="checkbox-wrapper" for="sendAllRows">
          <input type="checkbox" id="sendAllRows" />
          <span>Enviar todas as linhas do arquivo</span>
        </label>
      </div>
      <div class="button-group">
        <button id="saveBtn" type="button">Salvar</button>
        <button id="searchBtn" type="button">Busca</button>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
      function convertTypes(obj) {
        const result = {};
        for (const [key, value] of Object.entries(obj)) {
          if (typeof value === "string") {
            const lower = value.trim().toLowerCase();
            // Converte booleanos ("true"/"false")
            if (lower === "true") {
              result[key] = true;
              continue;
            }
            if (lower === "false") {
              result[key] = false;
              continue;
            }
            // Converte números
            if (!isNaN(value) && value.trim() !== "") {
              result[key] = parseFloat(value);
              continue;
            }
          }
          result[key] = value;
        }
        return result;
      }

      function excelSerialToDateString(serial) {
        const excelEpoch = new Date(1899, 11, 30);
        const millisecondsPerDay = 24 * 60 * 60 * 1000;
        const date = new Date(excelEpoch.getTime() + serial * millisecondsPerDay);
        return date.toISOString();
      }

      function convertExcelDates(obj) {
        const result = {};
        for (const [key, value] of Object.entries(obj)) {
          if (typeof value === 'number' && value > 25567 && value < 50000) {
            result[key] = excelSerialToDateString(value);
          } else if (typeof value === 'number' && key.toLowerCase().includes('timestamp')) {
            result[key] = excelSerialToDateString(value);
          } else if (typeof value === 'number' && key.toLowerCase().includes('date')) {
            result[key] = excelSerialToDateString(value);
          } else {
            result[key] = value;
          }
        }
        return result;
      }
      async function postData(url, data) {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data),
        });
        return response.json();
      }

      function getFullTestId() {
        const num = document.getElementById("testNumber").value.trim();
        return "TEST-" + num;
      }
      async function readFileAsJson(file, sendAll) {
        const extension = file.name.split('.').pop().toLowerCase();
        if (extension === "json") {
          const text = await file.text();
          const data = JSON.parse(text);
          return Array.isArray(data) ? data : [data];
        }
        if (extension === "csv") {
          const text = await file.text();
          const lines = text.trim().split("\n");
          const headers = lines[0].split(",").map(h => h.trim());
          if (lines.length < 2) throw new Error("O CSV está vazio ou sem dados.");
          const rows = lines.slice(1).map(line => {
            const values = line.split(",").map(v => v.trim());
            const rawData = Object.fromEntries(headers.map((h, i) => [h, values[i]]));
            return convertTypes(convertExcelDates(rawData));
          });
          return sendAll ? rows : [rows[0]];
        }
        if (extension === "xlsx") {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data, {
            type: "array"
          });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(sheet, {
            raw: false,
            dateNF: 'yyyy-mm-dd HH:MM:ss'
          });
          if (!rows.length) throw new Error("O arquivo XLSX está vazio.");
          const converted = rows.map(r => convertTypes(convertExcelDates(r)));
          return sendAll ? converted : [converted[0]];
        }
        throw new Error("Formato de arquivo não suportado (use .csv, .xlsx ou .json)");
      }
      document.getElementById("saveBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("fileInput");
      const sendAll = document.getElementById("sendAllRows").checked;

      if (fileInput.files.length === 0) {
        alert("Selecione um arquivo primeiro!");
        return;
      }

      try {
        const file = fileInput.files[0];
        const dataArray = await readFileAsJson(file, sendAll);

        for (let i = 0; i < dataArray.length; i++) {
          const data = dataArray[i];
          let testID =
            data.test_id ||
            data.TestID ||
            data["TEST ID"] ||
            data["test ID"] ||
            null;

          if (!testID) {
            testID = `TEST-${i + 1}`;
            console.warn(`TestID não encontrado na linha ${i + 1}. Usando ${testID}`);
          }

          const body = { testID, data };
          const result = await postData("/invoke", body);
          console.log(`Linha ${i + 1}:`, result);

          if (!sendAll) break;
          if (i < dataArray.length - 1) {
            const cont = confirm(`Linha ${i + 1} enviada (ID: ${testID}). Deseja enviar a próxima (${i + 2}/${dataArray.length})?`);
            if (!cont) {
              alert("Envio interrompido pelo usuário.");
              break;
            }
          }
        }

        alert("Envio concluído!");
      } catch (err) {
        console.error(err);
        alert("Erro ao processar o arquivo: " + err.message);
      }
    });
      // Botão de busca
      document.getElementById("searchBtn").addEventListener("click", async () => {
        const testID = getFullTestId();
        const searchAll = document.getElementById("searchAll").checked;
        const fcn = searchAll ? "GetAllTests" : "QueryTest";
        const body = {
          fcn,
          testID
        };
        const result = await postData("/query", body);
        console.log("Resultado da busca:", result);
        alert(JSON.stringify(result, null, 2));
      });
    </script>
  </body>
</html>